# Traditional Full Checkout Pipeline
# Demonstrates full repository checkout approach

name: 'Traditional-Checkout-$(Date:yyyyMMdd)-$(Rev:r)'

trigger: none

variables:
  - name: deploymentPath
    value: '$(Pipeline.Workspace)/deployment'
  - name: artifactName
    value: 'traditional-deployment-$(Build.BuildNumber)'
  - name: agentPoolName
    value: 'mac-demo-pool'
  - name: agentName
    value: 'mac-sparse-demo-agent'

jobs:
- job: 'TraditionalCheckout'
  displayName: 'Traditional Full Repository Checkout'
  timeoutInMinutes: 15
  pool:
    name: '$(agentPoolName)'
    demands:
    - agent.name -equals $(agentName)
  
  steps:
  - script: |
      start_time=$(date +%s)
      echo $start_time > /tmp/start_time_traditional
      echo "Starting traditional checkout at $(date)"
    displayName: 'Initialize Performance Timer'

  - checkout: self
    displayName: 'Full Repository Checkout'
    fetchDepth: 0
    fetchTags: true

  - script: |
      start_time=$(cat /tmp/start_time_traditional)
      end_time=$(date +%s)
      duration=$((end_time - start_time))
      
      echo "Checkout Duration: ${duration} seconds"
      echo "Total Directories: $(find . -type d | wc -l)"
      echo "Total Files: $(find . -type f | wc -l)"
      echo "Repository Size: $(du -sh . | cut -f1)"
      
      needed_files=$(grep -v '^#' deployment/deploy-list.txt | grep -v '^$' | wc -l)
      total_files=$(find . -name '*.py' -o -name '*.sql' -o -name '*.json' | wc -l)
      efficiency=$(echo "scale=1; $needed_files * 100 / $total_files" | bc)
      
      echo "Files Needed: $needed_files"
      echo "Files Downloaded: $total_files"
      echo "Efficiency: ${efficiency}%"
    displayName: 'Analyze Performance'

  - script: |
      mkdir -p $(deploymentPath)
      grep -v '^#' deployment/deploy-list.txt | grep -v '^$' | head -10 > /tmp/deploy_files
      tar -czf $(deploymentPath)/$(artifactName).tar.gz --files-from=/tmp/deploy_files 2>/dev/null || {
        find . -name "*.py" -path "./dags/*" | head -3 > /tmp/available_files
        find . -name "*.json" -path "./metadata/*" | head -2 >> /tmp/available_files
        find . -name "*.sql" -path "./data_model/*" | head -4 >> /tmp/available_files
        tar -czf $(deploymentPath)/$(artifactName).tar.gz --files-from=/tmp/available_files
      }
      echo "Package Size: $(du -sh $(deploymentPath)/$(artifactName).tar.gz | cut -f1)"
    displayName: 'Create Deployment Package'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Deployment Artifact'
    inputs:
      pathToPublish: '$(deploymentPath)'
      artifactName: 'traditional-deployment'
      publishLocation: 'Container'